<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DBulário - Monitoramento Bulário Eletrônico ANVISA</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background-color: #f4f6f8;
      color: #333;
    }
    header {
      background-color: #003366;
      color: white;
      padding: 2rem;
      text-align: center;
    }
    nav {
      background-color: #0055a5;
      display: flex;
      justify-content: center;
      padding: 1rem 0;
    }
    nav a {
      color: white;
      text-decoration: none;
      margin: 0 1.5rem;
      font-weight: 600;
    }
    nav a:hover {
      text-decoration: underline;
    }
    .container {
      max-width: 1000px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.75rem;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #e8f1fa;
    }
    .hidden {
      display: none;
    }
    .botoes a {
      margin-right: 1rem;
    }
    iframe {
      width: 100%;
      height: 600px;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
<header>
  <h1>DBulário - Monitoramento de Medicamentos</h1>
</header>

<nav>
  <a href="#" onclick="mostrarAba('inicio')">Início</a>
  <a href="#" onclick="mostrarAba('listaPersonalizada')">Lista Personalizada</a>
</nav>

<div class="container">
  <div id="inicio">
    <img src="logo.png" alt="Logo DBulário" style="height: 120px; display: block; margin: 0 auto 2rem auto;">

    <h2>Bem-vindo ao DBulário</h2>
    <p>Este projeto visa facilitar o acompanhamento das bulas dos medicamentos junto ao Bulário eletrônico da ANVISA.</p>
    <p>Se tiver interesse em contato comercial ou contribuir com o projeto, envie um e-mail para <a href="mailto:diorger@gmail.com">diorger@gmail.com</a>.</p>
  </div>

  <div id="listaPersonalizada" class="hidden">
    <h2>Lista de Referência Personalizada</h2>
    <p><strong>Filtro:</strong> digite os termos separados por vírgula (ex: 101070234,101070234) e selecione a coluna que deseja aplicar o filtro.</p>
    <input type="text" id="filtroTexto" placeholder="Digite os termos de busca">
    <div>
      <label><input type="checkbox" class="colunaFiltro" value="Detentor do registro" checked> Detentor</label>
      <label><input type="checkbox" class="colunaFiltro" value="cnpj" checked> CNPJ</label>
      <label><input type="checkbox" class="colunaFiltro" value="Produto" checked> Produto</label>
      <label><input type="checkbox" class="colunaFiltro" value="Registro" checked> Registro</label>
    </div>
    <table id="tabelaPersonalizada"></table>
    <div id="detalhes" class="hidden"></div>
  </div>
</div>

<script>
function mostrarAba(id) {
  document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

function carregarCSV(caminho, callback) {
  fetch(caminho)
    .then(response => response.text())
    .then(csv => {
      Papa.parse(csv, {
        header: true,
        skipEmptyLines: true,
        complete: results => callback(results.data)
      });
    });
}

function montarTabela(dados) {
  const tabela = document.getElementById('tabelaPersonalizada');
  tabela.innerHTML = '';
  if (dados.length === 0) return;

  const colunas = ['Detentor do registro','cnpj','Produto','Registro','Data Atualização Bulário'];
  const thead = '<thead><tr>' + colunas.map(col => `<th>${col}</th>`).join('') + '</tr></thead>';
  const tbody = '<tbody>' + dados.map((row, i) =>
    `<tr onclick="mostrarDetalhes(${i})">` +
    colunas.map(col => `<td>${row[col]}</td>`).join('') +
    '</tr>'
  ).join('') + '</tbody>';
  tabela.innerHTML = thead + tbody;
}

function filtrarDados(dados, texto, colunasSelecionadas) {
  if (!texto.trim()) return dados;
  const termos = texto.split(',').map(t => t.trim().toLowerCase());
  return dados.filter(row => {
    return colunasSelecionadas.some(col =>
      termos.some(termo => row[col] && row[col].toLowerCase().includes(termo))
    );
  });
}

let dadosGlobal = [];
let detalhesDiv = document.getElementById('detalhes');

function mostrarDetalhes(index) {
  const dados = dadosGlobal[index];
  const nome = dados['Produto'];
  const data = dados['Data Atualização Bulário'];
  const idPaciente = dados['idBulaPacienteProtegido'];
  const idProfissional = dados['idBulaProfissionalProtegido'];

  detalhesDiv.innerHTML = `
    <h3>Detalhes de ${nome}</h3>
    <p><strong>Atualizado em:</strong> ${data}</p>
    <div class="botoes">
      <p><strong>Versão Paciente:</strong></p>
      <a href="https://consultas.anvisa.gov.br/api/consulta/medicamentos/arquivo/bula/parecer/${idPaciente}/?Authorization=Guest" target="_blank"><button>Visualizar</button></a>
      <a href="https://consultas.anvisa.gov.br/api/consulta/medicamentos/arquivo/bula/parecer/${idPaciente}/?Authorization=Guest" download><button>Baixar</button></a>
      <iframe src="https://consultas.anvisa.gov.br/api/consulta/medicamentos/arquivo/bula/parecer/${idPaciente}/?Authorization=Guest"></iframe>
      <p><strong>Versão Profissional:</strong></p>
      <a href="https://consultas.anvisa.gov.br/api/consulta/medicamentos/arquivo/bula/parecer/${idProfissional}/?Authorization=Guest" target="_blank"><button>Visualizar</button></a>
      <a href="https://consultas.anvisa.gov.br/api/consulta/medicamentos/arquivo/bula/parecer/${idProfissional}/?Authorization=Guest" download><button>Baixar</button></a>
      <iframe src="https://consultas.anvisa.gov.br/api/consulta/medicamentos/arquivo/bula/parecer/${idProfissional}/?Authorization=Guest"></iframe>
    </div>
  `;
  detalhesDiv.classList.remove('hidden');
}

carregarCSV('StatusBulasANVISA.csv', dados => {
  dadosGlobal = dados;
  montarTabela(dados);

  document.getElementById('filtroTexto').addEventListener('input', () => {
    const texto = document.getElementById('filtroTexto').value;
    const colunasSelecionadas = Array.from(document.querySelectorAll('.colunaFiltro:checked')).map(cb => cb.value);
    const filtrados = filtrarDados(dadosGlobal, texto, colunasSelecionadas);
    montarTabela(filtrados);
    detalhesDiv.classList.add('hidden');
  });
});
</script>
</body>
</html>
